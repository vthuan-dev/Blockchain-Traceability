<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng thông tin - Nhà kiểm duyệt</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/nhakiemduyet.css">
    <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">

    <style>
      /* Đảm bảo modal được căn giữa màn hình */
.modal {
    display: none;
    position: fixed;
    z-index: 1050; /* Đảm bảo modal nằm trên các thành phần khác */
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4); /* Màu nền mờ */
    justify-content: center;
    align-items: center;
    display: flex;
}

/* Đảm bảo nội dung modal được căn giữa và có khoảng cách hợp lý */
.modal-content {
    background-color: #fefefe;
    margin: auto;
    padding: 20px;
    border: 1px solid #888;
    width: 90%; /* Giới hạn chiều rộng tối đa */
    max-width: 500px; /* Giới hạn chiều rộng tối đa */
    border-radius: 10px; /* Bo tròn góc */
    box-shadow: 0 5px 15px rgba(0,0,0,0.3); /* Đổ bóng */
    text-align: center; /* Căn giữa nội dung */
    position: relative; /* Để căn chỉnh nút đóng */
}

/* Nút đóng modal */
.close {
    color: #aaa;
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 28px;
    font-weight: bold;
}

.close:hover,
.close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}

/* Nút chức năng */
.function-button {
    padding: 10px 20px;
    background-color: #4CAF50;
    color: white;
    border: none;
    cursor: pointer;
    border-radius: 5px;
    margin: 10px;
    font-size: 16px;
    transition: background-color 0.3s ease;
}

.function-button:hover {
    background-color: #45a049;
}

/* Căn chỉnh các nút */
.button-container {
    display: flex;
    justify-content: center;
    gap: 20px; /* Khoảng cách giữa các nút */
    margin-top: 20px;
}

/* Responsive adjustments */
@media (max-width: 576px) {
    .modal-content {
        width: 95%; /* Giới hạn chiều rộng tối đa cho màn hình nhỏ */
        padding: 15px;
    }

    .function-button {
        padding: 8px 16px;
        font-size: 14px;
    }

    .button-container {
        flex-direction: column;
        gap: 10px; /* Khoảng cách giữa các nút */
    }
}

/* Đảm bảo modal backdrop có giá trị z-index thấp hơn modal */
.modal-backdrop {
    z-index: 1040; /* Đảm bảo backdrop nằm dưới modal */
}
        .status-pending { color: orange; }
        .status-approved { color: green; }
        .status-rejected { color: red; }

        .table-container {
            width: 100%;
            overflow-x: auto;
            margin-bottom: 1em;
        }

        .dashboard-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px; /* Đảm bảo bảng có chiều rộng tối thiểu */
        }

        .dashboard-table th, .dashboard-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        .dashboard-table th {
            background-color: #5bd657;
            position: sticky;
            top: 0;
            z-index: 0;
        }

        .dashboard-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .dashboard-table tr:hover {
            background-color: #f5f5f5;
        }

        .product-image, .certificate-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            margin: 2px;
            cursor: pointer;
        }

        .function-button {
            padding: 6px 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }

        .function-button:hover {
            background-color: #45a049;
        }

        .status-pending { color: orange; }
        .status-approved { color: green; }
        .status-rejected { color: red; }

        /* Responsive design */
        @media screen and (max-width: 600px) {
            .dashboard-table {
                font-size: 14px;
            }

            .dashboard-table th, .dashboard-table td {
                padding: 8px;
            }
        }
        
        
    </style>
</head>
<body>
    <!-- Thanh điều hướng -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light custom-navbar-height">
        <div class="logo">
            <img src="\hinhanh\Bitcoin-Blockchain-Network-icon-on-transparent-background-PNG.png" alt="Logo" class="logo-image">
        </div>
        <a class="navbar-brand" href="#">Nhà kiểm duyệt</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav"> <!-- Các mục điều hướng bên trái -->
                <li class="nav-item">
                    <a class="nav-link" href="#">Lô hàng</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Thông báo</a>
                </li>
            </ul>
            <ul class="navbar-nav ml-auto"> <!-- Menu dropdown bên phải -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <span id="userName">Tên người dùng</span>
                    </a>
                    <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                        <a class="dropdown-item" href="#" id="userRole">Vai trò</a>
                        <a class="dropdown-item" href="#" id="userRegion">Khu vực</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="#" id="logoutButton">Đăng xuất</a>
                    </div>
                </li>
            </ul>
        </div>
    </nav>
        
    <main>
        <div class="container mt-4">
            <div class="table-title">
                <h5><b>Lô bưởi đang chờ xử lý</b></h5>
            </div>
            <br>
            <div class="searchbox-filter">
                <input class="searchbox" id="myInput" type="text" placeholder="Tìm kiếm">
                <div class="dropdown">
                    <button onclick="searchFilter()" class="check-button"><b>Lọc</b></button>
                    <div id="filterDropdown" class="dropdown-content">
                        <a href="#all">Tất cả</a>
                        <a href="#checked">Đã kiểm định</a>
                        <a href="#uncheck">Chưa kiểm định</a>
                        <a href="#cancel">Đã từ chối</a>
                    </div>
                </div>  
            </div>
            <p></p>
            <div class="table-container">
                <table class="dashboard-table">
                    <thead>
                        <tr>
                            <th>Tên lô</th>
                            <th>Người sản xuất</th>
                            <th>Số lượng (tấn)</th>
                            <th>Ngày tạo</th>
                            <th>Hình ảnh</th>
                            <th>Giấy chứng nhận</th>
                            <th>Trạng thái</th>
                            <th>Chức năng</th>
                        </tr>
                    </thead>

                    <tbody id="d-table">
                        <!-- Các hàng sẽ được thêm động từ JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
    <script>AOS.init();</script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="js_giaodien/sanpham.js"></script>
    <script>
        
        let currentBatchId;

      document.addEventListener('DOMContentLoaded', function() {
        loadPendingBatches();
    });
    async function loadPendingBatches() {
            try {
                const response = await fetch('/pending-batches-by-region');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const batches = await response.json();
                displayPendingBatches(batches);
            } catch (error) {
                console.error('Lỗi khi lấy danh sách lô hàng chờ duyệt:', error);
                alert('Không thể lấy danh sách lô hàng. Vui lòng thử lại sau.');
            }
        }

        async function viewBatchDetails(batchId) {
            console.log('Đang lấy chi tiết cho lô hàng với ID:', batchId); // Thêm log để kiểm tra

            // Hiển thị modal với hai nút "Phê duyệt" và "Từ chối"
            const content = document.getElementById('batchDetailsContent');
            content.innerHTML = `
                <p>Bạn có muốn phê duyệt hoặc từ chối lô hàng này?</p>
                <div class="d-flex justify-content-center">
                    <button class="btn btn-success mx-2" onclick="approveBatch('${batchId}')">Phê duyệt</button>
                    <button class="btn btn-danger mx-2" onclick="rejectBatch('${batchId}')">Từ chối</button>
                </div>
            `;
            $('#batchDetailsModal').modal('show'); // Sử dụng Bootstrap để hiển thị modal
        }

        function closeModal() {
            $('#batchDetailsModal').modal('hide'); // Sử dụng Bootstrap để ẩn modal
}

        function addEventListeners() {
            const detailButtons = document.querySelectorAll('.detail-button');
            console.log('Detail buttons:', detailButtons); // Thêm log để kiểm tra

            detailButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const batchId = this.getAttribute('data-batch-id');
                    viewBatchDetails(batchId);
                });
            });

            const approveButtons = document.querySelectorAll('.approve-button');
            console.log('Approve buttons:', approveButtons); // Thêm log để kiểm tra

            approveButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const batchId = this.getAttribute('data-batch-id');
                    approveBatch(batchId);
                });
            });

            const rejectButtons = document.querySelectorAll('.reject-button');
            console.log('Reject buttons:', rejectButtons); // Thêm log để kiểm tra

            rejectButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const batchId = this.getAttribute('data-batch-id');
                    rejectBatch(batchId);
                });
            });
}


        function getStatusClass(status) {
            switch (status) {
                case 'Chờ phê duyệt':
                    return 'status-pending';
                case 'Đã phê duyệt':
                    return 'status-approved';
                case 'Đã từ chối':
                    return 'status-rejected';
                default:
                    return '';
            }
        }
       
        async function approveBatch(batchId) {
            try {
                const response = await fetch(`/approve-batch/${batchId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const result = await response.json();
                alert('Lô hàng đã được phê duyệt thành công');
                await loadPendingBatches();
            } catch (error) {
                console.error('Lỗi khi phê duyệt lô hàng:', error);
                alert('Không thể phê duyệt lô hàng. Vui lòng thử lại sau.');
            }
}

async function rejectBatch(batchId) {
    try {
        const response = await fetch(`/reject-batch/${batchId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        const result = await response.json();
        alert('Lô hàng đã bị từ chối');
        await loadPendingBatches();
    } catch (error) {
        console.error('Lỗi khi từ chối lô hàng:', error);
        alert('Không thể từ chối lô hàng. Vui lòng thử lại sau.');
    }
}
    function displayPendingBatches(batches) {
        const tableBody = document.getElementById('d-table');
        tableBody.innerHTML = '';

        batches.forEach(batch => {
            const row = document.createElement('tr');
            const statusClass = getStatusClass(batch.status);
            row.innerHTML = `
                <td>${batch.name}</td>
                <td>${batch.producerName}</td>
                <td>${batch.quantity}</td>
                <td>${new Date(Number(batch.productionDate) * 1000).toLocaleDateString()}</td>
                <td>${batch.productImageUrls.map(url => `<img src="${url}" alt="Product Image" class="product-image" onclick="showImage('${url}')">`).join('')}</td>
                <td><img src="${batch.certificateImageUrl}" alt="Certificate" class="certificate-image" onclick="showImage('${batch.certificateImageUrl}')"></td>
                <td class="${statusClass}">${batch.status}</td>
                <td>
                    <button class="function-button detail-button" data-batch-id="${batch.batchId}">Chi tiết</button>
                    <button class="function-button approve-button" data-batch-id="${batch.batchId}" style="display: none;">Phê duyệt</button>
                    <button class="function-button reject-button" data-batch-id="${batch.batchId}" style="display: none;">Từ chối</button>
                </td>
            `;
            tableBody.appendChild(row);
        });

        addEventListeners();
}

        function showImage(src) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.style.display = "block";
            modalImg.src = src;
        }

        // Đóng modal khi click vào nút đóng hoặc bên ngoài modal
        window.onclick = function(event) {
            const batchModal = document.getElementById('batchDetailsModal');
            const imageModal = document.getElementById('imageModal');
            if (event.target == batchModal || event.target == imageModal || event.target.className == 'close') {
                batchModal.style.display = 'none';
                imageModal.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const response = await fetch('/api/user-info');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('userName').textContent = data.name;
                    document.getElementById('userRole').textContent = `Vai trò: ${data.role}`;
                    document.getElementById('userRegion').textContent = `Khu vực: ${data.region}`;
                } else {
                    console.error('Không thể lấy thông tin người dùng');
                }
            } catch (error) {
                console.error('Lỗi:', error);
            }
        });

        // Xử lý đăng xuất
        document.getElementById('logoutButton').addEventListener('click', async function(e) {
            e.preventDefault();
            try {
                const response = await fetch('/api/dangxuat', { method: 'POST' });
                if (response.ok) {
                    window.location.href = '/dangnhap.html'; // Chuyển hướng về trang đăng nhập
                } else {
                    console.error('Không thể đăng xuất');
                }
            } catch (error) {
                console.error('Lỗi khi đăng xuất:', error);
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            var navbarToggler = document.querySelector('.navbar-toggler');
            var navbarCollapse = document.querySelector('.navbar-collapse');
            var menuOverlay = document.querySelector('.menu-overlay');
            
            function toggleMenu() {
                navbarCollapse.classList.toggle('show');
                document.body.classList.toggle('menu-open');
                if (menuOverlay) {
                    menuOverlay.classList.toggle('show');
                }
            }
            
            function closeMenu() {
                navbarCollapse.classList.remove('show');
                document.body.classList.remove('menu-open');
                if (menuOverlay) {
                    menuOverlay.classList.remove('show');
                }
            }
            
            navbarToggler.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleMenu();
            });
            
            if (menuOverlay) {
                menuOverlay.addEventListener('click', closeMenu);
            }
            
            document.addEventListener('click', function(e) {
                if (!navbarCollapse.contains(e.target) && !navbarToggler.contains(e.target)) {
                    closeMenu();
                }
            });
            
            // Ngăn sự kiện click trên menu lan ra ngoài
            navbarCollapse.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            // Xử lý cho dropdown trong menu
            var dropdowns = document.querySelectorAll('.navbar-nav .dropdown');
            dropdowns.forEach(function(dropdown) {
                dropdown.addEventListener('click', function(e) {
                    e.stopPropagation();
                    this.classList.toggle('show');
                });
            });
            
            var userDropdown = document.querySelector('.navbar-nav .dropdown');
            var userDropdownMenu = userDropdown.querySelector('.dropdown-menu');
            
            userDropdown.addEventListener('click', function(e) {
                e.stopPropagation();
                userDropdownMenu.classList.toggle('show');
            });
            
            document.addEventListener('click', function(e) {
                if (!userDropdown.contains(e.target)) {
                    userDropdownMenu.classList.remove('show');
                }
            });
        });


    
    </script>
    <div class="modal fade" id="batchDetailsModal" tabindex="-1" aria-labelledby="batchDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="batchDetailsModalLabel">Chi tiết lô hàng</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="batchDetailsContent">
                    <!-- Nội dung chi tiết lô hàng sẽ được thêm động từ JavaScript -->
                </div>
               
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
    <script>AOS.init();</script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="js_giaodien/sanpham.js"></script>
</body>
</html> 