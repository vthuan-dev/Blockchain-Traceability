<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang ch·ªß</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/trangchu.css">
    <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/sanpham.css">
    <link rel="stylesheet" href="../css/chatbox.css">
    <link rel="stylesheet" href="../css/lo-hang.css">
    <link rel="stylesheet" href="../css/trangcanhan.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        .product-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #ffffff;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            height: 100%;
            width: 100%;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .product-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            text-align: center;
            margin-bottom: 15px;
            height: auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-top: 10px;
        }

        .carousel-item .col-md-3 {
            padding: 15px;
        }

        #carouselProducts .carousel-inner {
            padding: 20px 0;
        }

        .carousel-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        .card-subtitle.mb-2.mt-4.text-muted {
            font-size: 1.2rem;
            color: #4CAF50 !important;
            margin-bottom: 15px !important;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Arial', sans-serif;
        }

        .container {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            padding: 30px;
            margin-top: 30px;
        }

        .custom-img {
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .custom-img:hover {
            transform: scale(1.05);
        }

        .ten_sanpham h3 {
            color: #2c3e50;
            font-size: 2rem;
            margin-top: 20px;
        }

        .price h3 {
            color: #27ae60;
            font-size: 1.5rem;
        }

        .thanhphan .col {
            background-color: #ecf0f1;
            border-radius: 10px;
            padding: 15px;
            margin: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 20%;
        }

        .thanhphan .col:hover {
            background-color: #44bd32;
            color: white;
        }

        .thanhphan .col i {
            margin-right: 0px;
        }

        .tab-content {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        .tab-content h2 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .tab-content ul, .tab-content ol {
            padding-left: 20px;
        }

        .tab-content li {
            margin-bottom: 10px;
        }

        .btn-view-image {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .btn-view-image:hover {
            background-color: #2980b9;
        }

        .batch-info table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 10px;
        }

        .batch-info th, .batch-info td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        .batch-info th {
            background-color: #44bd32;
            color: white;
            border-radius: 5px 0 0 5px;
        }

        .batch-info td {
            background-color: #ecf0f1;
            border-radius: 0 5px 5px 0;
        }

        .activity-log {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .activity-log p {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <nav class="navbar custom-navbar navbar-expand-lg navbar-light bg-light custom-navbar-height">
        <div class="logo-home">
            <a href="trangchu.html">
                <img src="\hinhanh\Bitcoin-Blockchain-Network-icon-on-transparent-background-PNG.png" alt="logo" class="logo">
            </a>
        </div>
        <a class="navbar-brand" href="#">Trang c√° nh√¢n</a>
        <button class="navbar-toggler ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto"> 
                <li class="nav-item active">
                    <a class="nav-link" href="allsanpham.html">S·∫£n ph·∫©m</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="allnongdan.html">Nh√† s·∫£n xu·∫•t</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="allnhakiemduyet.html">Nh√† ki·ªÉm duy·ªát</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">V√πng s·∫£n xu·∫•t</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Tin t·ª©c</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="./account/dangnhap.html">ƒêƒÉng nh·∫≠p</a>
                </li>
            </ul>
        </div>
    </nav>
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="#">Trang ch·ªß</a></li>
                <li class="breadcrumb-item active" id="breadcrumbTitle" aria-current="page">Th√¥ng tin l√¥ h√†ng</li>
            </ol>
        </nav>
        <div class="sanpham">
            <div class="row justify-content-center">
                <div class="col-md-10">
                    <div class="tieude text-center">
                        <div class="row no-gutters justify-content-center">
                            <div class="col-md-8 col-12 mb-4">
                                <img src="" alt="" class="img-fluid custom-img" onclick="showImage(this)">
                            </div>
                        </div>
                        <div class="ten_sanpham mb-3">
                            <h3 class="font-weight-bold"></h3>
                        </div>
                        <div class="price mb-4">
                            <h3 class="font-weight-bold"></h3>
                        </div>
                    </div>
                    <div class="thanhphan">
                        <div class="row no-gutters">
                            <div class="col-3 p-2">
                                <div class="tab-button" data-target="thongtin">
                                    <i class="fas fa-info-circle"></i>
                                    <span class="tab-text">Th√¥ng tin</span>
                                </div>
                            </div>
                            <div class="col-3 p-2">
                                <div class="tab-button" data-target="lienket">
                                    <i class="fas fa-link"></i>
                                    <span class="tab-text">C√°c b√™n li√™n quan</span>
                                </div>
                            </div>
                            <div class="col-3 p-2">
                                <div class="tab-button" data-target="xacthuc">
                                    <i class="fas fa-check-circle"></i>
                                    <span class="tab-text">X√°c th·ª±c</span>
                                </div>
                            </div>
                            <div class="col-3 p-2">
                                <div class="tab-button" data-target="lohang">
                                    <i class="fas fa-box"></i>
                                    <span class="tab-text">L√¥ h√†ng</span>
                                </div>
                            </div>
                        </div>
                        <div class="tab-content" id="thongtin">
                            <!-- N·ªôi dung th√¥ng tin s·∫£n ph·∫©m -->
                        </div>
                        <div class="tab-content" id="lienket">
                            <!-- N·ªôi dung c√°c b√™n li√™n quan -->
                        </div>
                        <div class="tab-content" id="xacthuc">
                            <!-- N·ªôi dung th√¥ng tin x√°c th·ª±c -->
                        </div>
                        <div class="tab-content" id="lohang">
                            <!-- N·ªôi dung th√¥ng tin l√¥ h√†ng -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="overlay" id="overlay" onclick="hideImage()">
        <img id="overlay-img" src="" alt="">
    </div>

    <!-- jQuery v√† Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="../js_giaodien/sanpham.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const sscc = urlParams.get('sscc');

        if (sscc) {
            try {
                const response = await fetch(`/api/batch-info-by-sscc-for-consumer/${sscc}`);
                const batchInfo = await response.json();

                if (response.ok) {
                    updateBatchInfo(batchInfo);
                    if (batchInfo.product) {
                        updateProductInfo(batchInfo.product);
                    } else {
                        console.error('Kh√¥ng t√¨m th·∫•y th√¥ng tin s·∫£n ph·∫©m');
                    }
                } else {
                    console.error('L·ªói khi l·∫•y th√¥ng tin l√¥ h√†ng:', batchInfo.error);
                }
            } catch (error) {
                console.error('L·ªói khi g·ªçi API:', error);
            }
        } else {
            console.error('Kh√¥ng t√¨m th·∫•y SSCC trong URL');
        }
    });
    
    async function updateBatchInfo(batchInfo) {
    // L·∫•y th√¥ng tin s·∫£n ph·∫©m t·ª´ SQL
    try {
        const response = await fetch(`/api/product/${batchInfo.productId}`);
        if (response.ok) {
            const productInfo = await response.json();
            updateProductInfo(productInfo);
            
            // C·∫≠p nh·∫≠t t√™n s·∫£n ph·∫©m, h√¨nh ·∫£nh v√† gi√°
            document.querySelector('.ten_sanpham h3').textContent = productInfo.product_name;
            document.querySelector('.custom-img').src = productInfo.img || '';
            document.querySelector('.price h3').innerHTML = `Gi√°: <span>${productInfo.price.toLocaleString('vi-VN')} ƒë</span>`;        } else {
            console.error('Kh√¥ng th·ªÉ l·∫•y th√¥ng tin s·∫£n ph·∫©m');
        }
    } catch (error) {
        console.error('L·ªói khi l·∫•y th√¥ng tin s·∫£n ph·∫©m:', error);
    }

    await updateRelatedParties(batchInfo);
    updateAuthenticationInfo(batchInfo);
    updateBatchDetails(batchInfo);

    document.querySelector('[data-target="lohang"]').click();
}

    function updateProductInfo(productInfo) {
        const thongtinContent = document.getElementById('thongtin');
        thongtinContent.innerHTML = `
            <h2>Th√¥ng tin s·∫£n ph·∫©m</h2>
            <table class="table table-bordered">
            
            <h4>M√¥ t·∫£:</h4>
            <ul>
                ${productInfo.description.split('\n').map(desc => `<li>${desc.trim()}</li>`).join('')}
            </ul>
            <h4>C√¥ng d·ª•ng:</h4>
            <ul>
                ${productInfo.uses.split('\n').map(use => `<li>${use.trim()}</li>`).join('')}
            </ul>
            <h4>Quy tr√¨nh s·∫£n xu·∫•t:</h4>
            <ol>
                ${productInfo.process.split('\n').map(step => `<li>${step.trim()}</li>`).join('')}
            </ol>
        `;
    }

    async function updateRelatedParties(batchInfo) {
        const lienketContent = document.getElementById('lienket');
        lienketContent.innerHTML = `
            <h2>C√°c b√™n c√≥ li√™n quan</h2>
            <p><strong>Nh√† s·∫£n xu·∫•t:</strong> ${batchInfo.producer.name}</p>
            <p><strong>ƒê·ªãa ch·ªâ:</strong> ${batchInfo.producer.address}</p>
            <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> ${batchInfo.producer.phone}</p>
            <h2>C√°c b√™n tham gia</h2>
            <div id="activityLogs">ƒêang t·∫£i...</div>
        `;

        try {
            const response = await fetch(`/api/system-activity-logs/${batchInfo.sscc}`);
            if (response.ok) {
                const data = await response.json();
                displayActivityLogs(data.activityLogs);
            } else {
                console.error('Kh√¥ng th·ªÉ l·∫•y nh·∫≠t k√Ω ho·∫°t ƒë·ªông');
                document.getElementById('activityLogs').innerHTML = 'Kh√¥ng th·ªÉ t·∫£i nh·∫≠t k√Ω ho·∫°t ƒë·ªông.';
            }
        } catch (error) {
            console.error('L·ªói khi l·∫•y nh·∫≠t k√Ω ho·∫°t ƒë·ªông:', error);
            document.getElementById('activityLogs').innerHTML = 'ƒê√£ x·∫£y ra l·ªói khi t·∫£i nh·∫≠t k√Ω ho·∫°t ƒë·ªông.';
        }
    }

    function displayActivityLogs(logs) {
    const logsContainer = document.getElementById('activityLogs');
    if (logs.length === 0) {
        logsContainer.innerHTML = 'Kh√¥ng c√≥ ho·∫°t ƒë·ªông n√†o ƒë∆∞·ª£c ghi nh·∫≠n.';
        return;
    }

    // S·∫Øp x·∫øp logs theo th·ªùi gian gi·∫£m d·∫ßn (m·ªõi nh·∫•t l√™n ƒë·∫ßu)
    logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    const initialDisplayCount = 5; // S·ªë l∆∞·ª£ng ho·∫°t ƒë·ªông hi·ªÉn th·ªã ban ƒë·∫ßu
    const displayLogs = (start, end) => {
        const logsHtml = logs.slice(start, end).map(log => `
         <div class="activity-log ${getActivityClass(log.activityName)}">
            <p class="timestamp"><strong>Th·ªùi gian:</strong> ${new Date(log.timestamp).toLocaleString('vi-VN')}</p>
            <p class="activity-name"><strong>Ho·∫°t ƒë·ªông:</strong> ${getActivityIcon(log.activityName)} ${translateActivityName(log.activityName)}</p>
            <p class="description"><strong>M√¥ t·∫£:</strong> ${translateDescription(log.description)}</p>
            ${log.imageUrls.length > 0 ? `<p><strong>H√¨nh ·∫£nh:</strong> <a href="${log.imageUrls[0]}" target="_blank" class="image-link">Xem h√¨nh ·∫£nh</a></p>` : ''}
        </div>
        `).join('');

        logsContainer.innerHTML = logsHtml;

        if (end < logs.length) {
            logsContainer.innerHTML += `
                <button id="loadMoreLogs" class="btn btn-primary mt-3">Xem th√™m</button>
            `;
            document.getElementById('loadMoreLogs').addEventListener('click', () => {
                displayLogs(0, end + 5);
            });
        }
    };

    displayLogs(0, initialDisplayCount);
}
function translateActivityName(activityName) {
    const translations = {
        "Transport Status Updated": "C·∫≠p nh·∫≠t tr·∫°ng th√°i v·∫≠n chuy·ªÉn",
        "Warehouse Confirmation": "X√°c nh·∫≠n nh√† kho",
        "Create Batch": "T·∫°o l√¥ h√†ng",
        "Start Transport": "B·∫Øt ƒë·∫ßu v·∫≠n chuy·ªÉn",
        "Warehouse Confirmation": "X√°c nh·∫≠n nh√† kho",
        "Stop Transport": "T·∫°m d·ª´ng v·∫≠n chuy·ªÉn",
        "Finish Transport": "Ho√†n th√†nh v·∫≠n chuy·ªÉn",
        "Batch Approved": "L√¥ h√†ng ƒë∆∞·ª£c ch·∫•p thu·∫≠n",

    };

    return translations[activityName] || activityName;
}

function translateDescription(description) {
    const translations = {
        "Bat dau van chuyen": "B·∫Øt ƒë·∫ßu v·∫≠n chuy·ªÉn",
        "Warehouse has confirmed receipt of the batch": "Nh√† kho ƒë√£ x√°c nh·∫≠n nh·∫≠n l√¥ h√†ng",
        "Hoan thanh van chuyen": "Ho√†n th√†nh v·∫≠n chuy·ªÉn",
        "Tam dung van chuyen": "T·∫°m d·ª´ng v·∫≠n chuy·ªÉn",
        "Batch has been approved by the approver": "L√¥ h√†ng ƒë√£ ƒë∆∞·ª£c nh√† ki·ªÉm duy·ªát ch·∫•p thu·∫≠n",
        // Th√™m c√°c b·∫£n d·ªãch kh√°c n·∫øu c·∫ßn
    };

    return translations[description] || description;
}

    function updateAuthenticationInfo(batchInfo) {
        const xacthucContent = document.getElementById('xacthuc');
        xacthucContent.innerHTML = `
            <h2>Th√¥ng tin x√°c th·ª±c</h2>
            <p><strong>Tr·∫°ng th√°i:</strong> ${batchInfo.status}</p>
            <p><strong>Ch·ª©ng nh·∫≠n:</strong> <a href="${batchInfo.certificateImageUrl}" target="_blank">Xem ch·ª©ng nh·∫≠n</a></p>
        `;
    }
    
    function updateBatchDetails(batchInfo) {
    const lohangContent = document.getElementById('lohang');
    lohangContent.innerHTML = `
        <div class="batch-info">
            <h2>Th√¥ng tin l√¥ h√†ng</h2>
            <table>
                <tr>
                    <th>T√™n l√¥ h√†ng</th>
                    <td>${batchInfo.name}</td>
                </tr>
                <tr>
                    <th>S·ªë l∆∞·ª£ng (t·∫•n)</th>
                    <td>${batchInfo.quantity}</td>
                </tr>
                <tr>
                    <th>Ng√†y t·∫°o l√¥ h√†ng</th>
                    <td>${new Date(batchInfo.productionDate).toLocaleDateString('vi-VN')}</td>
                </tr>
                <tr>
                    <th>Tr·∫°ng th√°i v·∫≠n chuy·ªÉn</th>
                    <td>${batchInfo.transportStatus}</td>
                </tr>
                <tr>
                    <th>Ng∆∞·ªùi s·∫£n xu·∫•t</th>
                    <td>${batchInfo.producer.name}</td>
                </tr>
                <tr>
                    <th>ƒê·ªãa ch·ªâ</th>
                    <td>${batchInfo.producer.address || 'Kh√¥ng c√≥ th√¥ng tin'}</td>
                </tr>
                <tr>
                    <th>S·ªë ƒëi·ªán tho·∫°i</th>
                    <td>${batchInfo.producer.phone || 'Kh√¥ng c√≥ th√¥ng tin'}</td>
                </tr>
            </table>
            <div class="text-center mt-4">
                <button class="btn-view-image" onclick="showProductImages('${batchInfo.productImageUrls.join(',')}')">XEM ·∫¢NH S·∫¢N PH·∫®M</button>
            </div>
        </div>
    `;
}
// H√†m ƒë·ªÉ hi·ªÉn th·ªã ·∫£nh s·∫£n ph·∫©m
function showProductImages(imageUrls) {
    const urls = imageUrls.split(',');
    if (urls.length > 0) {
        const overlay = document.getElementById('overlay');
        const overlayImg = document.getElementById('overlay-img');
        overlayImg.src = urls[0]; // Hi·ªÉn th·ªã ·∫£nh ƒë·∫ßu ti√™n
        overlay.style.display = 'flex';
    }
}

// ƒê·∫£m b·∫£o r·∫±ng b·∫°n ƒë√£ c√≥ h√†m hideImage() ƒë·ªÉ ƒë√≥ng overlay
function hideImage() {
    document.getElementById('overlay').style.display = 'none';
}
document.querySelectorAll('.tab-button').forEach(tab => {
    tab.addEventListener('click', function() {
        document.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        const target = this.getAttribute('data-target');
        document.querySelectorAll('.tab-content').forEach(content => {
            content.style.display = 'none';
        });
        document.getElementById(target).style.display = 'block';
    });
});

// K√≠ch ho·∫°t tab ƒë·∫ßu ti√™n khi trang ƒë∆∞·ª£c t·∫£i
document.querySelector('.tab-button').click();

function getActivityClass(activityName) {
    // Th√™m class CSS d·ª±a tr√™n lo·∫°i ho·∫°t ƒë·ªông
    switch(activityName.toLowerCase()) {
        case 'transport status updated': return 'activity-transport';
        case 'warehouse confirmation': return 'activity-confirm';
        default: return 'activity-default';
    }
}

function getActivityIcon(activityName) {
    // Th√™m bi·ªÉu t∆∞·ª£ng d·ª±a tr√™n lo·∫°i ho·∫°t ƒë·ªông
    switch(activityName.toLowerCase()) {
        case 'transport status updated': return 'üöö';
        case 'warehouse confirmation': return '‚úÖ';
        default: return 'üìù';
    }
}
    </script>
</body>
</html>