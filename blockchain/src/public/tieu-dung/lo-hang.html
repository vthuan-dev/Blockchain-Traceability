<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th√¥ng tin l√¥ h√†ng</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/trangchu.css">
    <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/sanpham.css">
    <link rel="stylesheet" href="../css/chatbox.css">
    <link rel="stylesheet" href="../css/lo-hang.css">
    <link rel="stylesheet" href="../css/trangcanhan.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <meta charset="UTF-8">
   
</head>
<body>
    <nav class="navbar custom-navbar navbar-expand-lg navbar-light bg-light custom-navbar-height">
        <div class="logo-home">
            <a href="trangchu.html">
                <img src="\hinhanh\Bitcoin-Blockchain-Network-icon-on-transparent-background-PNG.png" alt="logo" class="logo">
            </a>
        </div>
        <a class="navbar-brand" href="#">L√¥ h√†ng</a>
        <button class="navbar-toggler ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto"> 
                <li class="nav-item active">
                    <a class="nav-link" href="allsanpham.html">S·∫£n ph·∫©m</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="allnongdan.html">Nh√† s·∫£n xu·∫•t</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="allnhakiemduyet.html">Nh√† ki·ªÉm duy·ªát</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">V√πng s·∫£n xu·∫•t</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">Tin t·ª©c</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="./account/dangnhap.html">ƒêƒÉng nh·∫≠p</a>
                </li>
            </ul>
        </div>
    </nav>
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="#">Trang ch·ªß</a></li>
                <li class="breadcrumb-item active" id="breadcrumbTitle" aria-current="page">Th√¥ng tin l√¥ h√†ng</li>
            </ol>
        </nav>
        <div class="sanpham">
            <div class="row justify-content-center">
                <div class="col-md-10">
                    <div class="tieude text-center">
                        <div class="row no-gutters justify-content-center">
                            <div class="col-md-8 col-12 mb-4">
                                <img src="" alt="" class="img-fluid custom-img" onclick="showImage(this)">
                            </div>
                        </div>
                        <div class="ten_sanpham mb-3">
                            <h3 class="font-weight-bold"></h3>
                        </div>
                        <div class="price mb-4">
                            <h3 class="font-weight-bold"></h3>
                        </div>
                    </div>
                    <div class="thanhphan">
                        <div class="row no-gutters">
                            <div class="col-3 p-2">
                                <div class="tab-button" data-target="thongtin">
                                    <i class="fas fa-info-circle"></i>
                                    <span class="tab-text">Th√¥ng tin</span>
                                </div>
                            </div>
                            <div class="col-3 p-2">
                                <div class="tab-button" data-target="lienket">
                                    <i class="fas fa-link"></i>
                                    <span class="tab-text">C√°c b√™n li√™n quan</span>
                                </div>
                            </div>
                            <div class="col-3 p-2">
                                <div class="tab-button" data-target="xacthuc">
                                    <i class="fas fa-check-circle"></i>
                                    <span class="tab-text">X√°c th·ª±c</span>
                                </div>
                            </div>
                            <div class="col-3 p-2">
                                <div class="tab-button" data-target="lohang">
                                    <i class="fas fa-box"></i>
                                    <span class="tab-text">L√¥ h√†ng</span>
                                </div>
                            </div>
                        </div>
                        <div class="tab-content" id="thongtin">
                            <!-- N·ªôi dung th√¥ng tin s·∫£n ph·∫©m -->
                        </div>
                        <div class="tab-content" id="lienket">
                            <!-- N·ªôi dung c√°c b√™n li√™n quan -->
                        </div>
                        <div class="tab-content" id="xacthuc">
                            <!-- N·ªôi dung th√¥ng tin x√°c th·ª±c -->
                        </div>
                        <div class="tab-content" id="lohang">
                            <!-- N·ªôi dung th√¥ng tin l√¥ h√†ng -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="chat-icon" id="openChat" onclick="toggleChat()">
        <i class="fas fa-comments"></i>
        <div class="tooltip">ƒê·∫∑t c√¢u h·ªèi cho ch√∫ng t√¥i</div>
    </div>

    <!-- Khung chat -->
    <div id="chatbox" class="chatbox">
        <div class="chatbox-header">
            <strong>H·ªó tr·ª£</strong>
            <button id="closeChat" class="btn-close" onclick="toggleChat()">x</button>
        </div>
        <div class="chatbox-body">
            <ul id="messages" class="list-group">
                <li class="list-group-item system-message"><strong>H·ªá th·ªëng: </strong> Ch√†o b·∫°n, h√£y ƒë·∫∑t c√¢u h·ªèi c·ªßa b·∫°n.</li>
            </ul>
        </div>
        <div class="chatbox-footer">
            <form id="messageForm" class="d-flex">
                <input id="messageInput" type="text" class="form-control" placeholder="type message">
                <button type="submit" class="btn btn-primary">Send</button>
            </form>
        </div>
    </div>

    <div class="overlay" id="overlay" onclick="hideImage()">
        <img id="overlay-img" src="" alt="">
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.js"></script>
    <!-- jQuery v√† Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="../js_giaodien/sanpham.js"></script>

    <script src="../chatbox/chatbox.js"></script>

    <script>
       function toggleChat() {
            var chatbox = document.getElementById("chatbox");
            if (chatbox.classList.contains("show")) {
                chatbox.classList.remove("show");
                chatbox.classList.add("hide");
                setTimeout(() => {
                    chatbox.style.display = "none";
                    chatbox.classList.remove("hide");
                }, 300); // Match this to the animation duration
            } else {
                chatbox.style.display = "block";
                // Force a reflow before adding the 'show' class
                chatbox.offsetHeight;
                chatbox.classList.add("show");
            }
        }
    </script>

    <script>
  document.addEventListener('DOMContentLoaded', async function() {
    const urlParams = new URLSearchParams(window.location.search);
    const sscc = urlParams.get('sscc');
    if (sscc) {
        try {
            const response = await fetch(`/api/batch-info-by-sscc-for-consumer/${sscc}`);
            const batchInfo = await response.json();
            if (response.ok) {
                updateBatchInfo(batchInfo);
            } else {
                console.error('L·ªói khi l·∫•y th√¥ng tin l√¥ h√†ng:', batchInfo.error);
            }
        } catch (error) {
            console.error('L·ªói khi g·ªçi API:', error);
        }
    } else {
        console.error('Kh√¥ng t√¨m th·∫•y SSCC trong URL');
    }
});
    async function updateBatchInfo(batchInfo) {
    // L·∫•y th√¥ng tin s·∫£n ph·∫©m t·ª´ SQL
    try {
        const response = await fetch(`/api/product/${batchInfo.productId}`);
        if (response.ok) {
            const productInfo = await response.json();
            updateProductInfo(productInfo);
            
            // C·∫≠p nh·∫≠t t√™n s·∫£n ph·∫©m, h√¨nh ·∫£nh v√† gi√°
            document.querySelector('.ten_sanpham h3').textContent = productInfo.product_name;
            document.querySelector('.custom-img').src = productInfo.img || '';
            document.querySelector('.price h3').innerHTML = `Gi√°: <span>${productInfo.price.toLocaleString('vi-VN')} ƒë</span>`;        } else {
            console.error('Kh√¥ng th·ªÉ l·∫•y th√¥ng tin s·∫£n ph·∫©m');
        }
    } catch (error) {
        console.error('L·ªói khi l·∫•y th√¥ng tin s·∫£n ph·∫©m:', error);
    }

    await updateRelatedParties(batchInfo);
    updateAuthenticationInfo(batchInfo);
    updateBatchDetails(batchInfo);

    document.querySelector('[data-target="lohang"]').click();
}

    function updateProductInfo(productInfo) {
        const thongtinContent = document.getElementById('thongtin');
        thongtinContent.innerHTML = `
            <h2>Th√¥ng tin s·∫£n ph·∫©m</h2>
            <table class="table table-bordered">
            
            <h4>M√¥ t·∫£:</h4>
            <ul>
                ${productInfo.description.split('\n').map(desc => `<li>${desc.trim()}</li>`).join('')}
            </ul>
            <h4>C√¥ng d·ª•ng:</h4>
            <ul>
                ${productInfo.uses.split('\n').map(use => `<li>${use.trim()}</li>`).join('')}
            </ul>
            <h4>Quy tr√¨nh s·∫£n xu·∫•t:</h4>
            <ol>
                ${productInfo.process.split('\n').map(step => `<li>${step.trim()}</li>`).join('')}
            </ol>
        `;
    }
    async function updateRelatedParties(batchInfo) {
        const lienketContent = document.getElementById('lienket');
        
        console.log('Batch Info:', batchInfo);

        const producerId = batchInfo.producerId;
        console.log('Producer ID:', producerId);

        if (!batchInfo.producer) {
            console.error('Kh√¥ng c√≥ th√¥ng tin v·ªÅ nh√† s·∫£n xu·∫•t');
            lienketContent.innerHTML = '<p>Kh√¥ng c√≥ th√¥ng tin v·ªÅ nh√† s·∫£n xu·∫•t</p>';
            return;
        }

        const producerName = batchInfo.producer.name || 'Kh√¥ng c√≥ t√™n';
        const producerAddress = batchInfo.producer.address || 'Kh√¥ng c√≥ th√¥ng tin';
        const producerPhone = batchInfo.producer.phone || 'Kh√¥ng c√≥ th√¥ng tin';

        lienketContent.innerHTML = `
        <h2>C√°c b√™n c√≥ li√™n quan</h2>
        <p><strong>Nh√† s·∫£n xu·∫•t:</strong> <a href="/trangcanhan.html?uid=${producerId}" class="producer-link">${producerName}</a></p>
        <p><strong>ƒê·ªãa ch·ªâ:</strong> ${producerAddress}</p>
        <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> ${producerPhone}</p>
        <h5 class="activity-log-title">Nh·∫≠t k√Ω l√¥ h√†ng</h5>
        <div id="activityLogs">ƒêang t·∫£i...</div>
        `;

        // Ph·∫ßn c√≤n l·∫°i c·ªßa h√†m gi·ªØ nguy√™n
        try {
            const response = await fetch(`/api/system-activity-logs/${batchInfo.sscc}`);
            if (response.ok) {
                const data = await response.json();
                displayActivityLogs(data.activityLogs);
            } else {
                console.error('Kh√¥ng th·ªÉ l·∫•y nh·∫≠t k√Ω ho·∫°t ƒë·ªông');
                document.getElementById('activityLogs').innerHTML = 'Kh√¥ng th·ªÉ t·∫£i nh·∫≠t k√Ω ho·∫°t ƒë·ªông.';
            }
        } catch (error) {
            console.error('L·ªói khi l·∫•y nh·∫≠t k√Ω ho·∫°t ƒë·ªông:', error);
            document.getElementById('activityLogs').innerHTML = 'ƒê√£ x·∫£y ra l·ªói khi t·∫£i nh·∫≠t k√Ω ho·∫°t ƒë·ªông.';
        }
}

// Th√™m h√†m n√†y v√†o script c·ªßa b·∫°n
function goToProducerPage(producerId) {
    if (producerId) {
        window.location.href = `trangcanhan.html?uid=${producerId}`;
    } else {
        console.error('Kh√¥ng c√≥ ID ng∆∞·ªùi s·∫£n xu·∫•t');
    }
}
function displayActivityLogs(logs) {
    const logsContainer = document.getElementById('activityLogs');
    if (logs.length === 0) {
        logsContainer.innerHTML = 'Kh√¥ng c√≥ ho·∫°t ƒë·ªông n√†o ƒë∆∞·ª£c ghi nh·∫≠n.';
        return;
    }

    // S·∫Øp x·∫øp logs theo th·ªùi gian gi·∫£m d·∫ßn (m·ªõi nh·∫•t l√™n ƒë·∫ßu)
    logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    const initialDisplayCount = 5; // S·ªë l∆∞·ª£ng ho·∫°t ƒë·ªông hi·ªÉn th·ªã ban ƒë·∫ßu
    const displayLogs = (start, end) => {
        const logsHtml = logs.slice(start, end).map(log => {
            const participant = log.participantInfo;
            const participantInfo = participant ? 
                `
                <div class="participant-info">
                    <img src="${participant.avatar || '/images/default-avatar.png'}" alt="${participant.name}" class="participant-avatar">
                    <div class="participant-details">
                        <a href="${BASE_URL}/trangcanhan.html?uid=${participant.id}" class="participant-link">
                            <p class="participant-name">${participant.name}</p>
                            <p class="participant-role">${participant.role}</p>
                        </a>
                    </div>
                </div>
                ` : 
                `<p><strong>Ng∆∞·ªùi th·ª±c hi·ªán ID:</strong> ${log.participantId}</p>`;

            return `
            <div class="activity-log ${getActivityClass(log.activityName)}">
                <p class="timestamp"><strong>Th·ªùi gian:</strong> ${new Date(log.timestamp).toLocaleString('vi-VN')}</p>
                <p class="activity-name"><strong>Ho·∫°t ƒë·ªông:</strong> ${getActivityIcon(log.activityName)} ${translateActivityName(log.activityName)}</p>
                ${participantInfo}
                <p class="description"><strong>M√¥ t·∫£:</strong> ${decodeAndTranslateDescription(log.description)}</p>
                ${log.imageUrls && log.imageUrls.length > 0 ? `<p><strong>H√¨nh ·∫£nh:</strong> <a href="${log.imageUrls[0]}" target="_blank" class="image-link">Xem h√¨nh ·∫£nh</a></p>` : ''}
            </div>
            `;
        }).join('');

        logsContainer.innerHTML = logsHtml;

        if (end < logs.length) {
            logsContainer.innerHTML += `
                    <button id="loadMoreLogs">Xem th√™m</button>            `;
            document.getElementById('loadMoreLogs').addEventListener('click', () => {
                displayLogs(0, end + 5);
            });
        }
    };

    displayLogs(0, initialDisplayCount);
}
function decodeAndTranslateDescription(description) {
    // Gi·∫£i m√£ HTML entities
    const decodedDescription = decodeHTMLEntities(description);
    
    // D·ªãch m√¥ t·∫£
    return translateDescription(decodedDescription);
}

function decodeHTMLEntities(text) {
    const textArea = document.createElement('textarea');
    textArea.innerHTML = text;
    return textArea.value;
}

function translateDescription(description) {
    const translations = {
        "Bat dau van chuyen": "B·∫Øt ƒë·∫ßu v·∫≠n chuy·ªÉn",
        "Warehouse has confirmed receipt of batch": "Nh√† kho ƒë√£ x√°c nh·∫≠n nh·∫≠n l√¥ h√†ng",
        "Hoan thanh van chuyen": "Ho√†n th√†nh v·∫≠n chuy·ªÉn",
        "Tam dung van chuyen": "T·∫°m d·ª´ng v·∫≠n chuy·ªÉn",
        "Batch has been approved by the approver": "L√¥ h√†ng ƒë√£ ƒë∆∞·ª£c nh√† ki·ªÉm duy·ªát ch·∫•p thu·∫≠n",
        "Transport status updated to 'Hoan thanh van chuyen'": "Tr·∫°ng th√°i v·∫≠n chuy·ªÉn ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh 'Ho√†n th√†nh v·∫≠n chuy·ªÉn'",
        "Transport status updated to 'Bat dau van chuyen'": "Tr·∫°ng th√°i v·∫≠n chuy·ªÉn ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh 'B·∫Øt ƒë·∫ßu v·∫≠n chuy·ªÉn'",
        "Transport status updated to 'Tam dung van chuyen'": "Tr·∫°ng th√°i v·∫≠n chuy·ªÉn ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh 'T·∫°m d·ª´ng v·∫≠n chuy·ªÉn'",
        "A new batch has been created": "M·ªôt l√¥ h√†ng m·ªõi ƒë√£ ƒë∆∞·ª£c t·∫°o",
        "Batch has been approved": "L√¥ h√†ng ƒë√£ ƒë∆∞·ª£c ch·∫•p thu·∫≠n"
    };

    // T√¨m v√† thay th·∫ø c√°c ph·∫ßn c·ªßa m√¥ t·∫£
    for (const [key, value] of Object.entries(translations)) {
        if (description.includes(key)) {
            description = description.replace(key, value);
        }
    }

    return description;
}

function translateActivityName(activityName) {
    const translations = {
        "Transport Status Updated": "C·∫≠p nh·∫≠t tr·∫°ng th√°i v·∫≠n chuy·ªÉn",
        "Warehouse Confirmation": "Nh√† kho x√°c nh·∫≠n nh·∫≠n l√¥ h√†ng",
        "Create Batch": "T·∫°o l√¥ h√†ng",
        "Start Transport": "B·∫Øt ƒë·∫ßu v·∫≠n chuy·ªÉn",
        "Stop Transport": "T·∫°m d·ª´ng v·∫≠n chuy·ªÉn",
        "Finish Transport": "Ho√†n th√†nh v·∫≠n chuy·ªÉn",
        "Batch Approved": "L√¥ h√†ng ƒë∆∞·ª£c ph√™ duy·ªát",
        "Batch Created": "T·∫°o l√¥ h√†ng"
    };

    return translations[activityName] || activityName;
}

    function updateAuthenticationInfo(batchInfo) {
        const xacthucContent = document.getElementById('xacthuc');
        xacthucContent.innerHTML = `
            <h2>Th√¥ng tin x√°c th·ª±c</h2>
            <p><strong>Tr·∫°ng th√°i:</strong> ${batchInfo.status}</p>
            <p><strong>Ch·ª©ng nh·∫≠n:</strong> <a href="${batchInfo.certificateImageUrl}" target="_blank">Xem ch·ª©ng nh·∫≠n</a></p>
        `;
    }
    
    function updateBatchDetails(batchInfo) {
    const lohangContent = document.getElementById('lohang');
    lohangContent.innerHTML = `
        <div class="batch-info">
            <h2>Th√¥ng tin l√¥ h√†ng</h2>
            <table>
                <tr>
                    <th>T√™n l√¥ h√†ng</th>
                    <td>${batchInfo.name}</td>
                </tr>
                <tr>
                    <th>S·ªë l∆∞·ª£ng (t·∫•n)</th>
                    <td>${batchInfo.quantity}</td>
                </tr>
                <tr>
                    <th>Ng√†y t·∫°o l√¥ h√†ng</th>
                    <td>${new Date(batchInfo.productionDate).toLocaleDateString('vi-VN')}</td>
                </tr>
                <tr>
                    <th>Tr·∫°ng th√°i v·∫≠n chuy·ªÉn</th>
                    <td>${batchInfo.transportStatus}</td>
                </tr>
                <tr>
                    <th>Ng∆∞·ªùi s·∫£n xu·∫•t</th>
                    <td>${batchInfo.producer.name}</td>
                </tr>
                <tr>
                    <th>ƒê·ªãa ch·ªâ</th>
                    <td>${batchInfo.producer.address || 'Kh√¥ng c√≥ th√¥ng tin'}</td>
                </tr>
                <tr>
                    <th>S·ªë ƒëi·ªán tho·∫°i</th>
                    <td>${batchInfo.producer.phone || 'Kh√¥ng c√≥ th√¥ng tin'}</td>
                </tr>
            </table>
          <div class="text-center mt-4">
            <button class="btn-view-image" onclick="showProductImages('${batchInfo.productImageUrls.join(',')}')">
                <i class="fas fa-camera mr-2"></i> Xem ·∫£nh s·∫£n ph·∫©m
            </button>
            </div>
        </div>
    `;
}
// H√†m ƒë·ªÉ hi·ªÉn th·ªã ·∫£nh s·∫£n ph·∫©m
function showProductImages(imageUrls) {
    const urls = imageUrls.split(',');
    if (urls.length > 0) {
        const overlay = document.getElementById('overlay');
        const overlayImg = document.getElementById('overlay-img');
        overlayImg.src = urls[0]; // Hi·ªÉn th·ªã ·∫£nh ƒë·∫ßu ti√™n
        overlay.style.display = 'flex';
    }
}

// ƒê·∫£m b·∫£o r·∫±ng b·∫°n ƒë√£ c√≥ h√†m hideImage() ƒë·ªÉ ƒë√≥ng overlay
function hideImage() {
    document.getElementById('overlay').style.display = 'none';
}
document.querySelectorAll('.tab-button').forEach(tab => {
    tab.addEventListener('click', function() {
        document.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        const target = this.getAttribute('data-target');
        document.querySelectorAll('.tab-content').forEach(content => {
            content.style.display = 'none';
        });
        document.getElementById(target).style.display = 'block';
    });
});

// K√≠ch ho·∫°t tab ƒë·∫ßu ti√™n khi trang ƒë∆∞·ª£c t·∫£i
document.querySelector('.tab-button').click();

function getActivityClass(activityName) {
    // Th√™m class CSS d·ª±a tr√™n lo·∫°i ho·∫°t ƒë·ªông
    switch(activityName.toLowerCase()) {
        case 'transport status updated': return 'activity-transport';
        case 'warehouse confirmation': return 'activity-confirm';
        default: return 'activity-default';
    }
}

function getActivityIcon(activityName) {
    // Th√™m bi·ªÉu t∆∞·ª£ng d·ª±a tr√™n lo·∫°i ho·∫°t ƒë·ªông
    switch(activityName.toLowerCase()) {
        case 'transport status updated': return 'üöö';
        case 'warehouse confirmation': return '‚úÖ';
        default: return 'üìù';
    }
}
    </script>

<script>

    const BASE_URL = window.location.origin; // L·∫•y base URL c·ªßa ·ª©ng d·ª•ng
</script>
</body>
</html>