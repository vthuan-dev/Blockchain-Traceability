(function (root, factory) {(typeof module === 'object' && module.exports) ? module.exports = factory() : root.DnsOverHttpResolver = factory()}(typeof self !== 'undefined' ? self : this, function () {
"use strict";var DnsOverHttpResolver=(()=>{var ee=Object.create;var E=Object.defineProperty;var te=Object.getOwnPropertyDescriptor;var re=Object.getOwnPropertyNames;var se=Object.getPrototypeOf,oe=Object.prototype.hasOwnProperty;var T=(r,t)=>()=>(t||r((t={exports:{}}).exports,t),t.exports),ne=(r,t)=>{for(var e in t)E(r,e,{get:t[e],enumerable:!0})},I=(r,t,e,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of re(t))!oe.call(r,i)&&i!==e&&E(r,i,{get:()=>t[i],enumerable:!(o=te(t,i))||o.enumerable});return r};var z=(r,t,e)=>(e=r!=null?ee(se(r)):{},I(t||!r||!r.__esModule?E(e,"default",{value:r,enumerable:!0}):e,r)),ie=r=>I(E({},"__esModule",{value:!0}),r);var q=T((Te,K)=>{var y=1e3,v=y*60,F=v*60,b=F*24,ae=b*7,ce=b*365.25;K.exports=function(r,t){t=t||{};var e=typeof r;if(e==="string"&&r.length>0)return le(r);if(e==="number"&&isFinite(r))return t.long?he(r):ue(r);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(r))};function le(r){if(r=String(r),!(r.length>100)){var t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(r);if(t){var e=parseFloat(t[1]),o=(t[2]||"ms").toLowerCase();switch(o){case"years":case"year":case"yrs":case"yr":case"y":return e*ce;case"weeks":case"week":case"w":return e*ae;case"days":case"day":case"d":return e*b;case"hours":case"hour":case"hrs":case"hr":case"h":return e*F;case"minutes":case"minute":case"mins":case"min":case"m":return e*v;case"seconds":case"second":case"secs":case"sec":case"s":return e*y;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return e;default:return}}}}function ue(r){var t=Math.abs(r);return t>=b?Math.round(r/b)+"d":t>=F?Math.round(r/F)+"h":t>=v?Math.round(r/v)+"m":t>=y?Math.round(r/y)+"s":r+"ms"}function he(r){var t=Math.abs(r);return t>=b?$(r,t,b,"day"):t>=F?$(r,t,F,"hour"):t>=v?$(r,t,v,"minute"):t>=y?$(r,t,y,"second"):r+" ms"}function $(r,t,e,o){var i=t>=e*1.5;return Math.round(r/e)+" "+o+(i?"s":"")}});var H=T(($e,X)=>{function fe(r){e.debug=e,e.default=e,e.coerce=d,e.disable=f,e.enable=i,e.enabled=l,e.humanize=q(),e.destroy=g,Object.keys(r).forEach(s=>{e[s]=r[s]}),e.names=[],e.skips=[],e.formatters={};function t(s){let n=0;for(let c=0;c<s.length;c++)n=(n<<5)-n+s.charCodeAt(c),n|=0;return e.colors[Math.abs(n)%e.colors.length]}e.selectColor=t;function e(s){let n,c=null,x,j;function C(...h){if(!C.enabled)return;let m=C,_=Number(new Date),Q=_-(n||_);m.diff=Q,m.prev=n,m.curr=_,n=_,h[0]=e.coerce(h[0]),typeof h[0]!="string"&&h.unshift("%O");let A=0;h[0]=h[0].replace(/%([a-zA-Z%])/g,(S,V)=>{if(S==="%%")return"%";A++;let N=e.formatters[V];if(typeof N=="function"){let Y=h[A];S=N.call(m,Y),h.splice(A,1),A--}return S}),e.formatArgs.call(m,h),(m.log||e.log).apply(m,h)}return C.namespace=s,C.useColors=e.useColors(),C.color=e.selectColor(s),C.extend=o,C.destroy=e.destroy,Object.defineProperty(C,"enabled",{enumerable:!0,configurable:!1,get:()=>c!==null?c:(x!==e.namespaces&&(x=e.namespaces,j=e.enabled(s)),j),set:h=>{c=h}}),typeof e.init=="function"&&e.init(C),C}function o(s,n){let c=e(this.namespace+(typeof n>"u"?":":n)+s);return c.log=this.log,c}function i(s){e.save(s),e.namespaces=s,e.names=[],e.skips=[];let n,c=(typeof s=="string"?s:"").split(/[\s,]+/),x=c.length;for(n=0;n<x;n++)c[n]&&(s=c[n].replace(/\*/g,".*?"),s[0]==="-"?e.skips.push(new RegExp("^"+s.slice(1)+"$")):e.names.push(new RegExp("^"+s+"$")))}function f(){let s=[...e.names.map(a),...e.skips.map(a).map(n=>"-"+n)].join(",");return e.enable(""),s}function l(s){if(s[s.length-1]==="*")return!0;let n,c;for(n=0,c=e.skips.length;n<c;n++)if(e.skips[n].test(s))return!1;for(n=0,c=e.names.length;n<c;n++)if(e.names[n].test(s))return!0;return!1}function a(s){return s.toString().substring(2,s.toString().length-2).replace(/\.\*\?$/,"*")}function d(s){return s instanceof Error?s.stack||s.message:s}function g(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return e.enable(e.load()),e}X.exports=fe});var J=T((u,k)=>{u.formatArgs=Ce;u.save=pe;u.load=ge;u.useColors=de;u.storage=me();u.destroy=(()=>{let r=!1;return()=>{r||(r=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})();u.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function de(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function Ce(r){if(r[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+r[0]+(this.useColors?"%c ":" ")+"+"+k.exports.humanize(this.diff),!this.useColors)return;let t="color: "+this.color;r.splice(1,0,t,"color: inherit");let e=0,o=0;r[0].replace(/%[a-zA-Z%]/g,i=>{i!=="%%"&&(e++,i==="%c"&&(o=e))}),r.splice(o,0,t)}u.log=console.debug||console.log||(()=>{});function pe(r){try{r?u.storage.setItem("debug",r):u.storage.removeItem("debug")}catch{}}function ge(){let r;try{r=u.storage.getItem("debug")}catch{}return!r&&typeof process<"u"&&"env"in process&&(r=process.env.DEBUG),r}function me(){try{return localStorage}catch{}}k.exports=H()(u);var{formatters:be}=k.exports;be.j=function(r){try{return JSON.stringify(r)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}}});var Z=T((ke,U)=>{"use strict";U.exports=P;var we=q(),p=P.prototype,ye=new Date%1e9;function ve(){return(Math.random()*1e9>>>0)+ye++}function P(r){r=r||{},this.id=r.id||ve(),this.max=r.max||1/0,this.items=r.items||[],this._lookup={},this.size=this.items.length,this.lastModified=new Date(r.lastModified||new Date);for(var t,e,o=this.items.length;o--;)t=this.items[o],e=new Date(t.expires)-new Date,this._lookup[t.key]=t,e>0?this.expire(t.key,e):e<=0&&this.delete(t.key)}p.has=function(r){return r in this._lookup};p.get=function(r){if(!this.has(r))return null;var t=this._lookup[r];return t.refresh&&this.expire(r,t.refresh),this.items.splice(this.items.indexOf(t),1),this.items.push(t),t.value};p.meta=function(r){if(!this.has(r))return null;var t=this._lookup[r];return"meta"in t?t.meta:null};p.set=function(r,t,e){var o=this._lookup[r],i=this._lookup[r]={key:r,value:t};return this.lastModified=new Date,o?(clearTimeout(o.timeout),this.items.splice(this.items.indexOf(o),1,i)):(this.size>=this.max&&this.delete(this.items[0].key),this.items.push(i),this.size++),e&&("ttl"in e&&this.expire(r,e.ttl),"meta"in e&&(i.meta=e.meta),e.refresh&&(i.refresh=e.ttl)),this};p.delete=function(r){var t=this._lookup[r];return t?(this.lastModified=new Date,this.items.splice(this.items.indexOf(t),1),clearTimeout(t.timeout),delete this._lookup[r],this.size--,this):!1};p.expire=function(r,t){var e=t||0,o=this._lookup[r];if(!o)return this;if(typeof e=="string"&&(e=we(t)),typeof e!="number")throw new TypeError("Expiration time must be a string or number.");return clearTimeout(o.timeout),o.timeout=setTimeout(this.delete.bind(this,o.key),e),o.expires=Number(new Date)+e,this};p.clear=function(){for(var r=this.items.length;r--;)this.delete(this.items[r].key);return this};p.toJSON=function(){for(var r=new Array(this.items.length),t,e=r.length;e--;)t=this.items[e],r[e]={key:t.key,meta:t.meta,value:t.value,expires:t.expires,refresh:t.refresh};return{id:this.id,max:isFinite(this.max)?this.max:void 0,lastModified:this.lastModified,items:r}}});var _e={};ne(_e,{default:()=>xe});var D=z(J(),1),O=z(Z(),1);var B=globalThis.fetch,G=globalThis.Headers,Me=globalThis.Request,Se=globalThis.Response;function M(r,t,e){return`${r}?name=${t}&type=${e}`}async function W(r,t){return await(await B(r,{headers:new G({accept:"application/dns-json"}),signal:t})).json()}function w(r,t){return`${t}_${r}`}var L=Object.assign((0,D.default)("dns-over-http-resolver"),{error:(0,D.default)("dns-over-http-resolver:error")}),R=class{_cache;_TXTcache;_servers;_request;_abortControllers;constructor(t={}){this._cache=new O.default({max:t?.maxCache??100}),this._TXTcache=new O.default({max:t?.maxCache??100}),this._servers=["https://cloudflare-dns.com/dns-query","https://dns.google/resolve"],this._request=t.request??W,this._abortControllers=[]}cancel(){this._abortControllers.forEach(t=>{t.abort()})}getServers(){return this._servers}_getShuffledServers(){let t=[...this._servers];for(let e=t.length-1;e>0;e--){let o=Math.floor(Math.random()*e),i=t[e];t[e]=t[o],t[o]=i}return t}setServers(t){this._servers=t}async resolve(t,e="A"){switch(e){case"A":return this.resolve4(t);case"AAAA":return this.resolve6(t);case"TXT":return this.resolveTxt(t);default:throw new Error(`${e} is not supported`)}}async resolve4(t){let e="A",o=this._cache.get(w(t,e));if(o!=null)return o;let i=!1;for(let f of this._getShuffledServers()){let l=new AbortController;this._abortControllers.push(l);try{let a=await this._request(M(f,t,e),l.signal),d=a.Answer.map(s=>s.data),g=Math.min(...a.Answer.map(s=>s.TTL));return this._cache.set(w(t,e),d,{ttl:g}),d}catch{l.signal.aborted&&(i=!0),L.error(`${f} could not resolve ${t} record ${e}`)}finally{this._abortControllers=this._abortControllers.filter(a=>a!==l)}}throw i?Object.assign(new Error("queryA ECANCELLED"),{code:"ECANCELLED"}):new Error(`Could not resolve ${t} record ${e}`)}async resolve6(t){let e="AAAA",o=this._cache.get(w(t,e));if(o!=null)return o;let i=!1;for(let f of this._getShuffledServers()){let l=new AbortController;this._abortControllers.push(l);try{let a=await this._request(M(f,t,e),l.signal),d=a.Answer.map(s=>s.data),g=Math.min(...a.Answer.map(s=>s.TTL));return this._cache.set(w(t,e),d,{ttl:g}),d}catch{l.signal.aborted&&(i=!0),L.error(`${f} could not resolve ${t} record ${e}`)}finally{this._abortControllers=this._abortControllers.filter(a=>a!==l)}}throw i?Object.assign(new Error("queryAaaa ECANCELLED"),{code:"ECANCELLED"}):new Error(`Could not resolve ${t} record ${e}`)}async resolveTxt(t){let e="TXT",o=this._TXTcache.get(w(t,e));if(o!=null)return o;let i=!1;for(let f of this._getShuffledServers()){let l=new AbortController;this._abortControllers.push(l);try{let a=await this._request(M(f,t,e),l.signal),d=a.Answer.map(s=>[s.data.replace(/['"]+/g,"")]),g=Math.min(...a.Answer.map(s=>s.TTL));return this._TXTcache.set(w(t,e),d,{ttl:g}),d}catch{l.signal.aborted&&(i=!0),L.error(`${f} could not resolve ${t} record ${e}`)}finally{this._abortControllers=this._abortControllers.filter(a=>a!==l)}}throw i?Object.assign(new Error("queryTxt ECANCELLED"),{code:"ECANCELLED"}):new Error(`Could not resolve ${t} record ${e}`)}clearCache(){this._cache.clear(),this._TXTcache.clear()}},xe=R;return ie(_e);})();
return DnsOverHttpResolver}));
